name: OPS Documentation CI/CD

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "ops-docs-pages"
  cancel-in-progress: true

jobs:
  build-and-deploy-docs:
    name: Build & Deploy OPS Documentation
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1. Checkout source
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. Set up Java (required by Structurizr tools)
      # --------------------------------------------------
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # --------------------------------------------------
      # 3. Download Structurizr CLI
      # --------------------------------------------------
      - name: Download Structurizr CLI
        run: |
          curl -L -o structurizr-cli.zip https://github.com/structurizr/cli/releases/download/v1.32.0/structurizr-cli-1.32.0.zip
          unzip structurizr-cli.zip -d structurizr-cli

      # --------------------------------------------------
      # 4. Validate Structurizr DSL
      # --------------------------------------------------
      - name: Validate Structurizr workspace
        run: |
          java -jar structurizr-cli/structurizr-cli.jar validate \
            -workspace workspace.dsl

      # --------------------------------------------------
      # 5. Export Structurizr Site (static HTML)
      # --------------------------------------------------
      - name: Generate documentation site
        run: |
          java -jar structurizr-cli/structurizr-cli.jar export \
            -workspace workspace.dsl \
            -format site \
            -output build/site

      # --------------------------------------------------
      # 6. Upload GitHub Pages artifact
      # --------------------------------------------------
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/site

      # --------------------------------------------------
      # 7. Deploy to GitHub Pages
      # --------------------------------------------------
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
